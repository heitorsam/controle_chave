SELECT fi.*, 
(SELECT COUNT(DISTINCT insp.CD_INSPECAO) 
 FROM inspecao_sesmt.INSPECAO insp
 INNER JOIN inspecao_sesmt.PERGUNTA perg
   ON perg.CD_PERGUNTA = insp.CD_PERGUNTA
 INNER JOIN inspecao_sesmt.GRUPO_PERGUNTA gp
   ON gp.CD_GRUPO_PERGUNTA = perg.CD_GRUPO_PERGUNTA
 WHERE gp.CD_FICHA_INSPECAO = fi.CD_FICHA_INSPECAO
) AS QTD_INSPECAO
SELECT *
FROM inspecao_sesmt.FICHA_INSPECAO fi
ORDER BY fi.CD_FICHA_INSPECAO DESC;

SELECT *
FROM inspecao_sesmt.GRUPO_PERGUNTA gp
WHERE gp.CD_FICHA_INSPECAO = 46;


SELECT *
FROM inspecao_sesmt.PERGUNTA prg
FOR UPDATE;
WHERe prg.CD_GRUPO_PERGUNTA = 3;

INSERT INTO inspecao_sesmt.PERGUNTA 
SELECT
inspecao_sesmt.SEQ_PERGUNTA.NEXTVAL AS CD_PERGUNTA,
'2' AS CD_GRUPO_PERGUNTA,
1 AS ORDEM,
'EPIs em boas condições de armazenamento?' AS DS_PERGUNTA,
'10' AS PESO,
'A' AS TP_STATUS,
'HSSAMPAIO' AS CD_USUARIO_CADASTRO,
SYSDATE AS HR_CADASTRO,
NULL AS CD_USUARIO_ULT_ALT,
NULL AS HR_ULT_ALT
FROM DUAL;

INSERT INTO inspecao_sesmt.PERGUNTA 
SELECT
inspecao_sesmt.SEQ_PERGUNTA.NEXTVAL AS CD_PERGUNTA,
'2' AS CD_GRUPO_PERGUNTA,
2 AS ORDEM,
'Local de armazenamento está sinalizado?' AS DS_PERGUNTA,
'10' AS PESO,
'A' AS TP_STATUS,
'HSSAMPAIO' AS CD_USUARIO_CADASTRO,
SYSDATE AS HR_CADASTRO,
NULL AS CD_USUARIO_ULT_ALT,
NULL AS HR_ULT_ALT
FROM DUAL;


INSERT INTO inspecao_sesmt.PERGUNTA 
SELECT
inspecao_sesmt.SEQ_PERGUNTA.NEXTVAL AS CD_PERGUNTA,
'3' AS CD_GRUPO_PERGUNTA,
1 AS ORDEM,
'A margem de segurança das caixas estão sendo respeitadas?' AS DS_PERGUNTA,
'10' AS PESO,
'A' AS TP_STATUS,
'HSSAMPAIO' AS CD_USUARIO_CADASTRO,
SYSDATE AS HR_CADASTRO,
NULL AS CD_USUARIO_ULT_ALT,
NULL AS HR_ULT_ALT
FROM DUAL;

INSERT INTO inspecao_sesmt.PERGUNTA 
SELECT
inspecao_sesmt.SEQ_PERGUNTA.NEXTVAL AS CD_PERGUNTA,
'4' AS CD_GRUPO_PERGUNTA,
1 AS ORDEM,
'Há pasta de FISPQ no local?' AS DS_PERGUNTA,
'10' AS PESO,
'A' AS TP_STATUS,
'HSSAMPAIO' AS CD_USUARIO_CADASTRO,
SYSDATE AS HR_CADASTRO,
NULL AS CD_USUARIO_ULT_ALT,
NULL AS HR_ULT_ALT
FROM DUAL;

INSERT INTO inspecao_sesmt.PERGUNTA 
SELECT
inspecao_sesmt.SEQ_PERGUNTA.NEXTVAL AS CD_PERGUNTA,
'5' AS CD_GRUPO_PERGUNTA,
1 AS ORDEM,
'Os extintores e hidrantes estão desobstruídos?' AS DS_PERGUNTA,
'10' AS PESO,
'A' AS TP_STATUS,
'HSSAMPAIO' AS CD_USUARIO_CADASTRO,
SYSDATE AS HR_CADASTRO,
NULL AS CD_USUARIO_ULT_ALT,
NULL AS HR_ULT_ALT
FROM DUAL;

INSERT INTO inspecao_sesmt.PERGUNTA 
SELECT
inspecao_sesmt.SEQ_PERGUNTA.NEXTVAL AS CD_PERGUNTA,
'5' AS CD_GRUPO_PERGUNTA,
2 AS ORDEM,
'O descarte de luvas de procedimento está sendo feito em local adequado?' AS DS_PERGUNTA,
'15' AS PESO,
'A' AS TP_STATUS,
'HSSAMPAIO' AS CD_USUARIO_CADASTRO,
SYSDATE AS HR_CADASTRO,
NULL AS CD_USUARIO_ULT_ALT,
NULL AS HR_ULT_ALT
FROM DUAL;

--SUBSELECT PERGUNTANDO QUANTAS INSPECOES JA FORAM FEITAS COM A PERGUNTA

SELECT perg.*,
(SELECT COUNT(*) FROM inspecao_sesmt.INSPECAO insp WHERE insp.CD_PERGUNTA = perg.CD_PERGUNTA) AS QTD_PERG_INSP 
FROM inspecao_sesmt.PERGUNTA perg
WHERE perg.CD_GRUPO_PERGUNTA = '2'
ORDER BY perg.ORDEM ASC

UPDATE inspecao_sesmt.PERGUNTA perg
SET perg.ORDEM = '',
    perg.DS_PERGUNTA = '',
    perg.PESO = '',
    perg.CD_USUARIO_ULT_ALT = '',
    perg.HR_ULT_ALT = SYSDATE
WHERE perg.CD_PERGUNTA = '';

SELECT gp.*,
(SELECT COUNT(*) FROM inspecao_sesmt.INSPECAO insp
                 INNER JOIN inspecao_sesmt.PERGUNTA perg
                   ON perg.CD_PERGUNTA = insp.CD_PERGUNTA
                 WHERE perg.CD_GRUPO_PERGUNTA = gp.CD_GRUPO_PERGUNTA) AS QTD_PERG_INSP 
FROM inspecao_sesmt.GRUPO_PERGUNTA gp
WHERE gp.CD_FICHA_INSPECAO = '$var_codigo_ficha'
ORDER BY gp.ORDEM ASC;

INSERT INTO inspecao_sesmt.LOCAL 
SELECT
inspecao_sesmt.SEQ_LOCAL.NEXTVAL AS CD_LOCAL,
'Clínica Dolzani' AS DS_LOCAL,
'A' AS TP_STATUS,
'HSSAMPAIO' AS CD_USUARIO_CADASTRO,
SYSDATE AS HR_CADASTRO,
NULL AS CD_USUARIO_ULT_ALT,
NULL AS HR_ULT_ALT
FROM DUAL;
